<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三年級國語科學力測驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.8; }
        .question-group, .question-sub-group { 
            border-left: 4px solid transparent; 
            transition: border-color 0.3s; 
            padding-left: 1rem;
            margin-bottom: 2rem;
        }
        .correct { border-left-color: #22c55e; background-color: #f0fdf4; }
        .incorrect { border-left-color: #ef4444; background-color: #fef2f2; }
        .reading-passage {
            background-color: #f8fafc;
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }
        .question-sub-group {
            margin-left: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        #password-modal, #teacher-panel { display: none; } /* 預設隱藏 */
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">教師登入</h3>
            <p class="text-sm text-gray-600 mb-4">請輸入密碼以查看作答紀錄。</p>
            <input type="password" id="password-input" class="w-full p-2 border border-gray-300 rounded-lg mb-4" placeholder="請輸入密碼...">
            <div class="flex justify-end gap-3">
                <button id="password-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="password-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">確認</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-4xl p-4 sm:p-8">
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-md">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">國語科學力檢測(三)</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-600 mt-2">三年級</h2>
        </header>
        
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
            <div id="student-info-container">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">考生資訊</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700 mb-1">班級</label>
                        <input type="text" id="student-class" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                        <input type="text" id="student-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div id="student-info-error" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>

            <form id="quiz-form" class="mt-8">
                <div id="quiz-container" class="space-y-6">
                    <!-- Questions will be dynamically inserted here -->
                </div>
                <div class="mt-10 text-center">
                    <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        系統載入中...
                    </button>
                </div>
            </form>

            <div id="results" class="hidden mt-8">
                <h2 class="text-2xl font-bold text-center mb-4">測驗結果</h2>
                <div id="score" class="text-4xl font-bold text-center text-blue-700 mb-2"></div>
                <div id="summary" class="text-center text-lg mb-8"></div>
                <div id="db-status" class="text-center text-sm text-gray-500 mb-6"></div>
                <div class="flex justify-center items-center gap-4">
                    <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        下載錯誤報告
                    </button>
                    <button id="retry-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        再答一次
                    </button>
                </div>
            </div>
        </div>
        
        <div id="teacher-login-container" class="text-center mt-12 border-t pt-8">
            <button id="teacher-login-btn" class="text-blue-600 hover:underline">教師登入</button>
        </div>

        <div id="teacher-panel" class="hidden mt-8 bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold">教師後台 - 三年級國語作答紀錄</h2>
                <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">
                    匯出為 Excel (CSV)
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">作答時間</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">班級</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分數</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Teacher data will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 設定區 ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mandarin-quiz-g3-112-singlepage';
        const teacherPassword = "pingking1@";
        
        // --- 題目資料 (已根據112年題本校正並將題組整合) ---
        const questionData = [
            { "question": "1. 下列「 」內的字，哪一個讀音與另外三個不同？", "options": ["① 玩具店中有許多奇「形」怪狀的玩偶。", "② 這個人因為偷東西而被法院判「刑」。", "③ 在各種「行」業中，馴獸師最吸引我。", "④ 他的髮「型」怪異，穿著也與眾不同。"], "answer": 3 },
            { "question": "2. 這齣音樂劇的女主「角」前一天演出時撞到桌「角」而受傷，因此今天的演出由其他人代替她上場。\n上面的「角」字，按照順序應該讀作什麼？", "options": ["① ㄐㄩㄝˊ/ㄐㄧㄠˇ", "② ㄐㄧㄠˇ/ㄐㄩㄝˊ", "③ ㄐㄩㄝˊ/ㄐㄩㄝˊ", "④ ㄐㄧㄠˇ/ㄐㄧㄠˇ"], "answer": 4 },
            { "question": "3. 明天的戶外教育要「 」船欣賞日月潭風光，所以老師今天「 」醒我們要特別注意安全。\n上面句子「 」內的字，按照順序應該填入什麼？", "options": ["① 搭/題", "② 塔/題", "③ 搭/提", "④ 塔/提"], "answer": 3 },
            { "question": "4. 下列哪一個選項「 」內的國字完全正確？", "options": ["① 百步蛇花「蚊」是排灣族「文」化的特色。", "② 他頭「帶」遮陽帽，拎著手提「袋」出門。", "③ 美味的「祕」「密」都記在媽媽的腦海裡。", "④ 家裡的紅番「署」被老「鼠」咬了一大口。"], "answer": 3 },
            { "question": "5. 「大快朵頤」的意思和下列哪一個選項最接近？", "options": ["① 痛快的大吃一頓", "② 一直數菜有幾盤", "③ 感到心情很快樂", "④ 動作很敏捷迅速"], "answer": 1 },
            { "question": "6. 「哭泣」的「哭」和「泣」兩個字都有「掉眼淚」的意思。下列哪一個選項中的詞語，也是由兩個意思接近的字組成？", "options": ["① 冰涼", "② 冰塊", "③ 冰山", "④ 冰刀"], "answer": 1 },
            { "question": "7. 提供兩種以上的狀況讓人選擇的句型，就是「選擇句」。請問下列哪一個選項是「選擇句」？", "options": ["① 爺爺雖然退休了，卻過得比以前還忙碌。", "② 因為今天下大雨，運動會只好臨時取消。", "③ 你想要吃咖哩飯，還是要吃蝦仁蛋炒飯？", "④ 請你仔細的想想，不努力會有好成績嗎？"], "answer": 3 },
            { "question": "8. 下列哪一個句子最合理、通順？", "options": ["① 因為叔叔闖入紅綠燈，才發生了車禍。", "② 到學校後，我們會先做一個打掃的動作。", "③ 他雖然功課不好，同學們還是很喜歡他。", "④ 哥哥非常十分調皮，就喜歡去捉弄弟弟。"], "answer": 3 },
            { "question": "9. 下列哪一個選項的標點符號使用最正確？", "options": ["① 我喜歡吃西瓜、奇異果、香蕉。", "② 去外公家可以看到雞、鴨、豬。", "③ 路上車子的顏色有紅色、黑色、白色。", "④ 我的長褲有紅色的、藍色的、白色的。"], "answer": 2 },
            { "question": "10. 知道自己考了第一名，妹妹開心得要飛上天了。\n上面的句子利用「飛上天」形容妹妹的心情，這樣誇張的表現方法叫作「誇飾法」。下列哪一個句子也使用了「誇飾法」？", "options": ["① 向日葵總是向著太陽微笑。", "② 這個錢包居然要賣三萬元。", "③ 冰塊在我的嘴裡慢慢融化。", "④ 我餓得可以吞下一頭大象。"], "answer": 4 },
            { "question": "11. 仙草汁看起來黑黑的，像極了墨水。\n上面的句子利用墨水比擬仙草汁的樣子，這樣的表現方法叫作「譬喻法」。下列哪一個句子也使用了「譬喻法」？", "options": ["① 最近爸爸常打哈欠，好像沒有睡飽的樣子。", "② 蘋果樹上結實纍纍，像掛著一顆顆紅寶石。", "③ 妹妹畫了一張圖畫，送給媽媽當生日禮物。", "④ 滿天的星星亮啊亮，熱情的向我們打招呼。"], "answer": 2 },
            { "question": "12. 上面文章的A、B、C三段，內容分別是描述「現在的情況」還是「過去的情況」？請按照A、B、C的順序排列。", "options": ["① 現在的情況→過去的情況→現在的情況", "② 過去的情況→現在的情況→現在的情況", "③ 現在的情況→過去的情況→過去的情況", "④ 過去的情況→過去的情況→現在的情況"], "answer": 1, "passage": "A.這是一張充滿了開心回憶的照片。我看著這張照片，想起那段歡樂的時光。\nB.十年前的夏天,堂哥從美國回鄉下老家度假。他時常帶著我們這一群小孩,到田裡挖地瓜、追蜻蜓;到小溪捉魚蝦、打水仗。沒玩到天色昏暗,絕不輕易踏上回家的路途。\nC.看著照片中渾身沾滿泥巴,手上還捧著一堆地瓜的我們,我不禁懷念起在遠方的堂哥。堂哥,你最近過得好嗎?什麼時候再與我們來場鄉間探險呢?" },
            { "question": "13. 本段文字，屬於下列哪一種文本？", "options": ["① 詩歌", "② 應用文", "③ 記敘文", "④ 說明文"], "answer": 3, "passage": "我們一領到書箱,就馬上出發,想趕快搬回教室。我爬上三樓時,已經氣喘如牛了,其他同學也是上氣不接下氣,個個滿臉通紅,好像番茄一樣。大家你看我、我看你,忍不住哈哈大笑,真是有趣!" },
            { "question": "14. 「食」最早的意思是指「食物」，後來又有「吃、吃飯」的意思。下面哪一個句子中的「食」字是「吃、吃飯」的意思？", "options": ["① 奶奶時常告誡我們，糧「食」不可以浪費。", "② 如果「食」用沒煮熟的肉，可能會拉肚子。", "③ 一到假日，表妹總會到各地尋找美「食」。", "④ 阿公一心信仰佛教，所以長年吃素「食」。"], "answer": 2 },
            { "question": "15. 「貼」有黏附、接近、補助、虧損的意思，下列哪一個選項中的「貼」是「接近」的意思？", "options": ["① 我們將有興趣的文章剪「貼」到筆記本上。", "② 哥哥每天放學後都會去打工「貼」補家用。", "③ 為了找回愛犬，他四處張「貼」尋狗啟示。", "④ 因為害怕走失，所以妹妹緊「貼」著媽媽。"], "answer": 4 },
            { "question": "16. 經過班長詳細的介紹後，大家紛紛＿＿去臺東阿朗壹古道校外教學。", "options": ["① 認為", "② 同時", "③ 贊同", "④ 讚美"], "answer": 3 },
            { "question": "17. 下列句子中的「肯定」，哪一個的意思與其他三個不同？", "options": ["① 多讀好書，寫作能力「肯定」會進步的。", "② 他們非常有愛心，大家都「肯定」他們。", "③ 烏雲密布，待會兒「肯定」下一場大雨。", "④ 我喜歡這本小說，你們「肯定」也喜歡。"], "answer": 2 },
            { "question": "18. 如果阿祥早一點出門，就可以買到限量的草莓冰淇淋了。", "options": ["① 阿祥天天都去買冰淇淋。", "② 阿祥出門的時間太早了。", "③ 阿祥最後買到冰淇淋了。", "④ 阿祥並沒有買到冰淇淋。"], "answer": 4 },
            { "question": "19. 不管是打棒球、游泳還是騎腳踏車，表弟都想嘗試看看。", "options": ["① 表弟曾經打棒球、游泳和騎腳踏車。", "② 表弟對打棒球和騎腳踏車都感興趣。", "③ 表弟只喜歡騎腳踏車，不喜歡游泳。", "④ 表弟很會打棒球、游泳和騎腳踏車。"], "answer": 2 },
            { "question": "20. 下列哪一個選項最適合當上面短文的重點？", "options": ["① 介紹翠玉白菜的外型特色和保存地點。", "② 說明故宮博物院收藏了三顆翠玉白菜。", "③ 有白綠相間的玉才可以雕出翠玉白菜。", "④ 大家都想到故宮博物院欣賞翠玉白菜。"], "answer": 1, "passage": "翠玉白菜不是白菜，而是一塊既潔白又翠綠的玉器。它本來是一顆白綠相間的玉，雕刻家利用它原有的顏色雕刻出白色菜柄及綠色菜葉，還在菜葉上刻出兩隻昆蟲，整件作品栩栩如生，十分精緻。翠玉白菜不止一顆，國立故宮博物院內收藏了三顆，因為會定期展示，所以吸引許多人慕名而來。" },
            { "question": "21. 這段文字主要想告訴我們什麼事情？", "options": ["① 蜜蜂最重要的工作不是為人類採蜜。", "② 大部分開花植物需要蜜蜂協助授粉。", "③ 蜜蜂大量消失，會讓人類的食物不足。", "④ 蜜蜂的大量消失，是一件很嚴重的事。"], "answer": 4, "passage": "蜜蜂在地球上最重要的工作不是為人類採蜜，而是為植物授粉。根據統計，人類的食物有十分之三以上來自開花植物，這些植物又有高達五分之四需要蜜蜂協助授粉，就連許多跟人類飲食無關的植物，也需依賴蜜蜂授粉來達到繁衍的目的。因此，蜂群的大量消失，不僅讓人類的生活大受影響，也會使自然生態失去平衡。" },
            {
                isGroup: true,
                passage: "眼中進了一粒沙子會不舒服，但卻沒想過，那粒沙子帶來的痛苦與煩惱，有可能會超過你我的想像呵！\n一天清晨，我在附近學校的操場慢跑，一陣風揚起地上的落葉和塵土後，有一粒沙子掉到我的右眼裡。雖然我覺得有點不舒服，還是不在意的繼續跑步。\n一開始，我以為可以輕易的用淚水把右眼這粒沙子沖掉，但是小沙粒卻頑強的不離開，把我的眼球扎得非常刺痛。我拚命的眨眼睛，想把它趕出右眼，無奈一點也沒幫助。我想，如果我的眼皮能像蚌殼那樣，分泌出黏液把沙子變成珍珠，那我就忍痛讓它存在好了；可是，它既成不了珍珠，我的右眼也越來越痛。我的右眼從流眼淚、紅腫、發炎到晚上幾乎已經睜不開了，這嚴重影響到我的生活。\n隔天一早我就趕緊去找眼科醫師求救。\n醫師檢查我的右眼之後，他說因為沙子磨破右眼的結膜，所以我會感到難受，而且再慢一點接受治療就麻煩了。醫師為我取出沙子，洗了眼，點了藥水，接著他要我閉上眼睛，用長長的膠帶把一塊無菌紗布牢牢固定在我的右眼上。這時，我的右臉從額頭到面頰全被膠帶貼住，不但右眼看不見，右半臉的肌肉也無法自由活動。不過，雖然我右眼看不見、右臉不舒服，卻安心了不少。\n過了兩天兩夜「獨眼龍」的生活。第三天，醫師幫我把膠帶撕去，並確認我的右眼視力一切正常。當時那種重見天日的感覺，我到今天還記得清清楚楚。",
                questions: [
                    { "question": "22. 根據文章內容，下列哪一個選項是正確的？", "options": ["① 眼裡的小沙子影響了作者的生活。", "② 沙子在作者的右眼裡待了好幾天。", "③ 作者用淚水沖出了眼裡的小沙子。", "④ 眼睛裡的沙子有可能會變成珍珠。"], "answer": 1 },
                    { "question": "23. 下列哪一個選項，最符合作者的心情轉變過程？", "options": ["① 擔心→安心→喜悅→不在意", "② 擔心→安心→不在意→喜悅", "③ 不在意→擔心→喜悅→安心", "④ 不在意→擔心→安心→喜悅"], "answer": 4 },
                    { "question": "24. 這篇文章主要想告訴我們什麼道理？", "options": ["① 運動時一定要注意安全。", "② 小問題也可能有大影響。", "③ 曾經失去才能懂得珍惜。", "④ 眼睛受傷要治療好幾天。"], "answer": 2 }
                ]
            },
            {
                isGroup: true,
                passage: "你知道食譜上寫的刀工：滾刀、切片等指的是什麼嗎？食材的大小、形狀不只會影響料理的外觀，也會影響烹調的時間和口感。在開始烹飪前，先學習切割食材的方法吧！\n第一個方法是滾刀，通常用在切有點硬的食材上，像是馬鈴薯和茄子。將刀子斜斜的在食材上切一塊，再將食材滾一下再切一刀，重複這個動作就能把食材切成不規則的塊狀。滾刀塊適合長時間燉煮的料理，如燉馬鈴薯肉醬。\n切片就是將食材切成約兩毫米厚度的片狀。刀子與食材垂直，可切成圓片狀；以斜角切下，食材就變成比較大片的橢圓形。切片的食材適合用於炒或煎的料理，例如炒小黃瓜。\n切絲是一種切成細長狀的方法，可以隨著料理的需求和口感，調整成粗絲或細絲。粗絲約為五毫米，細絲約二毫米。除了用手切，也能用專用的刨刀刨成更細薄的絲狀，更能節省備菜時間。炒馬鈴薯絲、青椒炒肉絲等，都是常見的切絲料理。\n最後一種切法是切末，是將食材切成細碎的樣子，常見的有蒜末、洋蔥末。切得細碎的辛香料，可以在烹調後讓食材的風味更好，所以在爆香蒜頭前，常會使用這種切法。較大的食材如果要切末，先切片，接著切絲，最後切碎、切細。",
                questions: [
                    { "question": "25. 文章中總共提到幾種用手切食材的方法？", "options": ["① 三種", "② 四種", "③ 五種", "④ 六種"], "answer": 2 },
                    { "question": "26. 文章中提到「除了用手切，也能用專用的刨刀刨成更細薄的絲狀」，表示用刨刀刨出的食材應該是下列哪一個選項？", "options": ["① 比切末更短一些", "② 比切末更碎一些", "③ 比切絲更粗一些", "④ 比切絲更細一些"], "answer": 4 },
                    { "question": "27. 這篇文章主要想告訴我們什麼？", "options": ["① 滾刀多用在切適合燉煮的食材。", "② 我們可以用小黃瓜來練習切片。", "③ 刀工會影響食材烹煮後的結果。", "④ 蔬菜是練習各種刀工的好食材。"], "answer": 3 }
                ]
            },
            {
                isGroup: true,
                passage: "達文西在西元1452年出生，那段時期，是歐洲人開始對藝術產生濃厚興趣的時期，就是「文藝復興時期」。\n達文西從小就喜歡畫畫，他在十四歲時跟著名的畫家福羅學畫。福羅是一位嚴格的老師。他在教室擺了一顆雞蛋，第一堂課就要達文西畫蛋。\n「畫雞蛋，再簡單不過了！」達文西心想。他很快的將蛋畫好，拿給老師看。福羅點點頭，沒說什麼。\n第二堂課，福羅對達文西說：「畫雞蛋吧！」達文西乖乖的把雞蛋畫下來。\n第三堂課，福羅又要達文西畫雞蛋，他心想：「老師怎麼又要我畫雞蛋呢？」\n第四堂課、第五堂課、第六堂課，甚至第七堂課，福羅還是要達文西畫雞蛋。\n達文西終於不耐煩了。「老師，您什麼技巧都不教我，就只叫我畫蛋。雞蛋長得都一樣，為什麼要花那麼多時間練習畫呢？ 」\n「你認為雞蛋長得都一樣嗎？」福羅看看達文西。\n「這小小的雞蛋，你從上看，從下看，從近看，從遠看，清晨看，傍晚看，看的角度和光線不同，都會讓雞蛋看起來不同。我要你畫出雞蛋細微的差異，這樣才能鍛鍊你畫畫的功力，培養基本功。」達文西聽完福羅講的話之後，才知道老師的用心，後來更發覺畫蛋其實並不簡單。\n經過多年的練習，達文西終於具備了繪畫的基本功，也靠著優秀的繪畫技巧，成為文藝復興時期最偉大的藝術家。他的名畫蒙娜麗莎，線條優美、顏色柔和又充滿情感。畫中的女士臉上那淺淺的微笑，更成為多年來人們持續討論的話題。",
                questions: [
                    { "question": "28. 根據文章內容，下列哪一個選項是正確的？", "options": ["① 蒙娜麗莎是文藝復興時期的名畫。", "② 達文西天生就有優秀的繪畫功力。", "③ 福羅因為很會畫蛋而成為著名的畫家。", "④ 達文西一開始畫蛋就知道福羅的用心。"], "answer": 1 },
                    { "question": "29. 根據文章內容，要畫出雞蛋細微的差異，除了要不斷的練習外，還要有什麼樣的能力？", "options": ["① 豐富的想像力", "② 良好的觀察力", "③ 過人的忍耐力", "④ 優秀的創作力"], "answer": 2 },
                    { "question": "30. 這篇文章主要想告訴我們什麼道理？", "options": ["① 想進步，就要不斷的努力練習。", "② 要學會畫畫，要先學會畫雞蛋。", "③ 嚴格的老師，才能教出好學生。", "④ 達文西是畫家，他很會畫雞蛋。"], "answer": 1 }
                ]
            }
        ];

        // --- Firebase 初始化 ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); 
        } catch (e) {
            console.error("Firebase 初始化失敗:", e);
            alert("系統載入失敗，請重新整理頁面。");
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("使用者已登入:", userId);
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("匿名或自訂Token登入失敗:", error);
                }
            }
            isAuthReady = true;
            // **FIX**: Enable submit button once auth is ready
            allDOM.submitBtn.disabled = false;
            allDOM.submitBtn.textContent = '送出答案';
        });

        // --- DOM 元素 ---
        const allDOM = {
            quizContainer: document.getElementById('quiz-container'),
            form: document.getElementById('quiz-form'),
            resultsContainer: document.getElementById('results'),
            scoreEl: document.getElementById('score'),
            summaryEl: document.getElementById('summary'),
            downloadBtn: document.getElementById('download-btn'),
            retryBtn: document.getElementById('retry-btn'),
            studentInfoContainer: document.getElementById('student-info-container'),
            studentInfoError: document.getElementById('student-info-error'),
            dbStatusEl: document.getElementById('db-status'),
            teacherLoginBtn: document.getElementById('teacher-login-btn'),
            teacherPanel: document.getElementById('teacher-panel'),
            resultsTableBody: document.getElementById('results-table-body'),
            submitBtn: document.getElementById('submit-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            passwordModal: document.getElementById('password-modal'),
            passwordInput: document.getElementById('password-input'),
            passwordSubmitBtn: document.getElementById('password-submit-btn'),
            passwordCancelBtn: document.getElementById('password-cancel-btn'),
        };

        let userAnswers = {};
        let flatQuestions = [];

        // --- UI Creation & Logic ---
        function initializeQuiz() {
            let questionCounter = 0;
            allDOM.quizContainer.innerHTML = ''; // 清空容器

            questionData.forEach((item) => {
                if (item.isGroup) {
                    // 處理題組
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'p-4 rounded-lg bg-gray-50 mb-4';
                    
                    // 顯示文章
                    const passageDiv = document.createElement('div');
                    passageDiv.className = 'reading-passage';
                    passageDiv.innerHTML = `<p class="whitespace-pre-wrap">${item.passage}</p>`;
                    groupContainer.appendChild(passageDiv);

                    // 顯示題組中的每個問題
                    item.questions.forEach(subItem => {
                        const questionDiv = createQuestionElement(subItem, questionCounter);
                        questionDiv.classList.add('question-sub-group');
                        groupContainer.appendChild(questionDiv);
                        flatQuestions.push(subItem);
                        questionCounter++;
                    });
                    allDOM.quizContainer.appendChild(groupContainer);
                } else {
                    // 處理單一問題
                    const questionDiv = createQuestionElement(item, questionCounter);
                    allDOM.quizContainer.appendChild(questionDiv);
                    flatQuestions.push(item);
                    questionCounter++;
                }
            });
            
            // 綁定事件監聽器
            allDOM.form.addEventListener('submit', submitQuiz);
            allDOM.retryBtn.addEventListener('click', retryQuiz);
            allDOM.downloadBtn.addEventListener('click', generateReportPage);
            allDOM.teacherLoginBtn.addEventListener('click', () => {
                allDOM.passwordModal.style.display = 'flex';
                allDOM.passwordInput.focus();
            });
            allDOM.passwordCancelBtn.addEventListener('click', () => {
                allDOM.passwordModal.style.display = 'none';
                allDOM.passwordInput.value = '';
            });
            allDOM.passwordSubmitBtn.addEventListener('click', handleLogin);
            allDOM.passwordInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleLogin();
            });
            allDOM.exportCsvBtn.addEventListener('click', exportToCsv);
        }

        function createQuestionElement(item, questionIndex) {
            const questionGroup = document.createElement('div');
            questionGroup.className = 'question-group p-4 rounded-lg';
            questionGroup.id = `question-${questionIndex}`;
            
            let content = '';
            if (item.passage) {
                 content += `<div class="reading-passage"><p class="whitespace-pre-wrap">${item.passage}</p></div>`;
            }

            content += `<p class="text-lg font-semibold mb-4">${item.question}</p>`;

            content += `<div class="space-y-2 mt-4">`;
            item.options.forEach((option, i) => {
                const optionIndex = i + 1;
                content += `
                    <label for="q${questionIndex}_o${optionIndex}" class="flex items-center p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-blue-50 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-400">
                        <input type="radio" id="q${questionIndex}_o${optionIndex}" name="question${questionIndex}" value="${optionIndex}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                        <span class="ml-3 text-gray-700">${option}</span>
                    </label>
                `;
            });
            content += `</div>`;

            questionGroup.innerHTML = content;
            return questionGroup;
        }

        async function submitQuiz(e) {
            e.preventDefault();

            const studentClassEl = document.getElementById('student-class');
            const studentNameEl = document.getElementById('student-name');
            const studentClass = studentClassEl.value.trim();
            const studentName = studentNameEl.value.trim();

            // **FIX**: Visual feedback for validation instead of alert
            studentClassEl.classList.remove('border-red-500');
            studentNameEl.classList.remove('border-red-500');
            allDOM.studentInfoError.classList.add('hidden');

            if (!studentClass || !studentName) {
                allDOM.studentInfoError.textContent = '請務必填寫班級和姓名！';
                allDOM.studentInfoError.classList.remove('hidden');
                if (!studentClass) studentClassEl.classList.add('border-red-500');
                if (!studentName) studentNameEl.classList.add('border-red-500');
                return;
            }
            
            allDOM.submitBtn.disabled = true;
            allDOM.submitBtn.textContent = '計算中...';

            let score = 0;
            userAnswers = {};
            
            flatQuestions.forEach((item, index) => {
                const selectedOption = allDOM.form.querySelector(`input[name="question${index}"]:checked`);
                const questionGroup = document.getElementById(`question-${index}`);

                if (selectedOption) {
                    const answer = parseInt(selectedOption.value);
                    userAnswers[index + 1] = answer;
                    if (answer === item.answer) {
                        score++;
                        questionGroup.classList.add('correct');
                    } else {
                        questionGroup.classList.add('incorrect');
                    }
                } else {
                    userAnswers[index + 1] = '未作答';
                    questionGroup.classList.add('incorrect');
                }
                questionGroup.querySelectorAll('input[type="radio"]').forEach(radio => radio.disabled = true);
            });

            const totalQuestions = flatQuestions.length;
            const finalScore = Math.round((score / totalQuestions) * 100);

            allDOM.dbStatusEl.textContent = '正在儲存作答紀錄...';
            try {
                const resultId = auth.currentUser ? auth.currentUser.uid : `${studentClass}-${studentName}-${Date.now()}`;
                const docRef = doc(db, "artifacts", appId, "public", "data", "results", resultId);
                await setDoc(docRef, {
                    studentClass: studentClass,
                    studentName: studentName,
                    score: finalScore,
                    correctCount: score,
                    totalQuestions: totalQuestions,
                    answers: userAnswers,
                    timestamp: new Date()
                });
                allDOM.dbStatusEl.textContent = '作答紀錄已成功儲存！';
                allDOM.dbStatusEl.style.color = 'green';
            } catch (error) {
                console.error("Error adding document: ", error);
                allDOM.dbStatusEl.textContent = '作答紀錄儲存失敗，請檢查網路連線或聯繫管理員。';
                allDOM.dbStatusEl.style.color = 'red';
            }

            allDOM.scoreEl.textContent = `${finalScore} 分`;
            allDOM.summaryEl.textContent = `答對 ${score} 題，共 ${totalQuestions} 題。`;

            allDOM.form.classList.add('hidden');
            allDOM.resultsContainer.classList.remove('hidden');
            
            allDOM.resultsContainer.scrollIntoView({ behavior: 'smooth' });
        };

        function generateReportPage() {
            const studentClass = document.getElementById('student-class').value.trim();
            const studentName = document.getElementById('student-name').value.trim();
            
            let incorrectQuestionsHTML = '';
            
            flatQuestions.forEach((item, index) => {
                const userAnswerKey = index + 1;
                const userAnswer = userAnswers[userAnswerKey];
                if (userAnswer !== item.answer) {
                    const questionText = item.question;
                    const userAnswerText = (userAnswer !== '未作答' && userAnswer) ? item.options[userAnswer - 1] : '未作答';
                    
                    let passageHTML = '';
                    // 找到這個問題所屬的文章
                    for (const group of questionData) {
                        if (group.isGroup && group.questions.includes(item)) {
                            passageHTML = `<div style="background-color:#f3f4f6; padding:10px; border-radius:5px; margin-bottom:10px; white-space: pre-wrap;">${group.passage}</div>`;
                            break;
                        }
                    }
                    if (!passageHTML && item.passage) {
                         passageHTML = `<div style="background-color:#f3f4f6; padding:10px; border-radius:5px; margin-bottom:10px; white-space: pre-wrap;">${item.passage}</div>`;
                    }


                    incorrectQuestionsHTML += `
                        <div style="margin-bottom: 1.5rem; padding-left: 1rem; border-left: 3px solid #ef4444;">
                            ${passageHTML}
                            <p style="margin-bottom: 0.5rem;"><strong>題目 ${index + 1}:</strong> ${questionText}</p>
                            <p>你的答案: ${userAnswerText}</p>
                        </div>`;
                }
            });

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head><title>測驗結果報告</title><style>body { font-family: 'Noto Sans TC', sans-serif; padding: 2rem; } h1, h2 { text-align: center; } .info, .score-summary { border-bottom: 2px solid #ccc; padding-bottom: 1rem; margin-bottom: 1rem; }</style></head>
                <body>
                    <h1>三年級國語科 測驗報告</h1>
                    <div class="info"><p><strong>班級:</strong> ${studentClass}</p><p><strong>姓名:</strong> ${studentName}</p></div>
                    <div class="score-summary"><h2>總成績: ${allDOM.scoreEl.textContent}</h2><p>${allDOM.summaryEl.textContent}</p></div>
                    <div><h3>錯誤題目列表</h3>${incorrectQuestionsHTML || '<p>恭喜你，全部答對了！</p>'}</div>
                </body>
                </html>`);
            reportWindow.document.close();
        };

        function retryQuiz() {
            window.location.reload();
        };

        async function showTeacherPanel() {
            allDOM.teacherPanel.style.display = 'block';
            allDOM.teacherPanel.scrollIntoView({ behavior: 'smooth' });
            
            allDOM.resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">正在載入紀錄...</td></tr>';
            
            try {
                const resultsCollectionRef = collection(db, "artifacts", appId, "public", "data", "results");
                const q = query(resultsCollectionRef);
                const querySnapshot = await getDocs(q);
                
                allDOM.resultsTableBody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    allDOM.resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">目前沒有任何作答紀錄。</td></tr>';
                    return;
                }
                
                let results = [];
                querySnapshot.forEach((doc) => {
                    results.push(doc.data());
                });

                results.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                results.forEach((data) => {
                    const date = data.timestamp.toDate();
                    const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    
                    const row = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.studentClass}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${data.score}</td>
                    </tr>`;
                    allDOM.resultsTableBody.innerHTML += row;
                });

            } catch (error) {
                console.error("Error getting documents: ", error);
                allDOM.resultsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">讀取紀錄失敗，請檢查網路連線或聯繫管理員。</td></tr>';
            }
        };
        
        const handleLogin = function() {
            const enteredPassword = allDOM.passwordInput.value;

            if (enteredPassword === teacherPassword) {
                allDOM.passwordModal.style.display = 'none';
                allDOM.passwordInput.value = '';
                showTeacherPanel();
            } else {
                alert("密碼錯誤！");
                allDOM.passwordInput.value = '';
            }
        };

        async function exportToCsv() {
            try {
                const resultsCollectionRef = collection(db, "artifacts", appId, "public", "data", "results");
                const q = query(resultsCollectionRef);
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    alert("目前沒有任何作答紀錄可匯出。");
                    return;
                }

                const records = [];
                querySnapshot.forEach((doc) => {
                    records.push(doc.data());
                });

                records.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                
                let csvContent = "";
                const headers = ["作答時間", "班級", "姓名", "分數", "答對題數"];
                const totalQuestions = flatQuestions.length;
                for (let i = 1; i <= totalQuestions; i++) {
                    headers.push(`第${i}題答案`);
                }
                csvContent += headers.join(',') + '\r\n';

                records.forEach(record => {
                    const date = record.timestamp.toDate();
                    const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
                    
                    let row = [
                        `"${formattedDate}"`,
                        `"${record.studentClass}"`,
                        `"${record.studentName}"`,
                        record.score,
                        record.correctCount
                    ];

                    for (let i = 1; i <= totalQuestions; i++) {
                        row.push(record.answers[i] || "未作答");
                    }
                    csvContent += row.join(',') + '\r\n';
                });

                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); 
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "三年級國語作答紀錄.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            } catch (error) {
                console.error("無法匯出CSV: ", error);
                alert("匯出紀錄失敗，請檢查網路連線或聯繫管理員。");
            }
        };
        
        initializeQuiz();
    </script>
</body>
</html>

